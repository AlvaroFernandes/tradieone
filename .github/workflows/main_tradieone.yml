name: Deploy Vite App to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build Vite project
      run: |
        npm run build
        echo "‚úÖ Build completed successfully"
        echo "Dist folder contents:"
        ls -la dist/
    
    - name: Create web.config for SPA routing
      run: |
        echo '<?xml version="1.0" encoding="UTF-8"?>
        <configuration>
          <system.webServer>
            <staticContent>
              <mimeMap fileExtension=".json" mimeType="application/json" />
            </staticContent>
            <rewrite>
              <rules>
                <rule name="SPA" stopProcessing="true">
                  <match url=".*" />
                  <conditions logicalGrouping="MatchAll">
                    <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                    <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                  </conditions>
                  <action type="Rewrite" url="/index.html" />
                </rule>
              </rules>
            </rewrite>
          </system.webServer>
        </configuration>' > dist/web.config
        echo "‚úÖ web.config created"
    
    - name: Deploy to Azure via Kudu
      env:
        # Use these EXACT values from your Azure credentials
        USERNAME: '$TradieOne'  # Literally: $TradieOne
        PASSWORD: 'PCJHSj6CBsARcejirbxlpLd3Zff4yDqiGRgSDBiloXxX572dQnn2H8KAGoDi'
      run: |
        echo "üöÄ Starting deployment to Azure..."
        
        # Create zip of dist folder
        cd dist
        zip -r ../deploy.zip . > /dev/null
        echo "üì¶ Created deploy.zip"
        
        # CORRECT KUDU URL for YOUR app
        KUDU_URL="https://app.tradieone.com/"
        
        echo "üîó Kudu URL: $KUDU_URL"
        echo "üë§ Username: $USERNAME"
        
        # Deploy using Kudu ZIP API
        echo "üì§ Uploading deployment package..."
        
        HTTP_CODE=$(curl -X POST \
          -u "$USERNAME:$PASSWORD" \
          "$KUDU_URL/api/zipdeploy" \
          --data-binary @../deploy.zip \
          --write-out "%{http_code}" \
          --silent \
          --output /tmp/response.txt)
        
        echo "üì° HTTP Response Code: $HTTP_CODE"
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
          echo "‚úÖ Deployment successful!"
          echo "Response: $(cat /tmp/response.txt)"
        else
          echo "‚ùå Deployment failed with code: $HTTP_CODE"
          echo "Error response: $(cat /tmp/response.txt)"
          exit 1
        fi
        
        # Cleanup
        rm -f ../deploy.zip
        
        echo ""
        echo "üéâ Your app is now live!"
        echo "üåê https://app.tradieone.com/"
    
    - name: Test deployed app
      run: |
        echo "üîç Testing deployed application..."
        sleep 5  # Give Azure a moment to deploy
        curl -I "https://app.tradieone.com/" \
          --max-time 10 \
          || echo "App might still be starting..."