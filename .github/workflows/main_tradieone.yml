name: Deploy to Azure

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - run: npm ci && npm run build
    
    - name: Debug - Check build output
      run: |
        echo "üìÅ Build output check:"
        echo "Files in dist folder:"
        ls -la dist/
        echo ""
        echo "Checking index.html:"
        [ -f "dist/index.html" ] && echo "‚úÖ index.html exists" || echo "‚ùå index.html missing"
        echo "First line of index.html:"
        head -1 dist/index.html
    
    - name: Create CORRECT web.config
      run: |
        # Complete, valid web.config
        cat > dist/web.config << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <configuration>
          <system.webServer>
            <staticContent>
              <mimeMap fileExtension=".json" mimeType="application/json" />
              <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
            </staticContent>
            <rewrite>
              <rules>
                <rule name="SPA" stopProcessing="true">
                  <match url=".*" />
                  <conditions logicalGrouping="MatchAll">
                    <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                    <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                  </conditions>
                  <action type="Rewrite" url="/index.html" />
                </rule>
              </rules>
            </rewrite>
            <httpProtocol>
              <customHeaders>
                <remove name="X-Powered-By" />
              </customHeaders>
            </httpProtocol>
          </system.webServer>
        </configuration>
        EOF
        
        echo "‚úÖ Valid web.config created"
    
    - name: Deploy
      run: |
        echo "üöÄ Starting deployment..."
        cd dist
        
        echo "üì¶ Files to deploy:"
        ls -la
        
        echo ""
        echo "üìÑ web.config verification:"
        head -10 web.config
        echo "..."
        tail -5 web.config
        
        # Create zip
        zip -r app.zip .
        
        echo ""
        echo "üì§ Deploying to Azure..."
        
        # Deploy
        curl -X POST \
          -u '$TradieOne:n7jBcellkKxSWcPslaw4wKTRlPgQMsxmz6BQmaf6BPWdfbtEduqYJn2Ax6uu' \
          https://tradieone-gpefeegnfqf5dwau.scm.australiaeast-01.azurewebsites.net/api/zipdeploy \
          --data-binary @app.zip
        
        echo ""
        echo "‚úÖ Deployment command sent!"
    
    - name: Restart App Service (if needed)
      run: |
        echo "üîÑ Restarting App Service..."
        # Using Azure CLI if you have credentials
        # az webapp restart --name TradieOne --resource-group appsvc_linux_australiaeast
        echo "If app still shows default page, manually restart in Azure Portal"
    
    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        echo "Waiting 10 seconds for Azure to process..."
        sleep 10
        
        echo ""
        echo "Testing Azure URL..."
        AZURE_URL="https://tradieone-gpefeegnfqf5dwau.australiaeast-01.azurewebsites.net"
        AZURE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$AZURE_URL" --max-time 15 || echo "000")
        echo "HTTP Status: $AZURE_STATUS"
        
        if [ "$AZURE_STATUS" -eq 200 ]; then
          echo "‚úÖ Azure URL is serving your app!"
          echo "Content preview:"
          curl -s "$AZURE_URL" | grep -o "<title>[^<]*</title>" || echo "Could not get title"
        elif [ "$AZURE_STATUS" -eq 403 ] || [ "$AZURE_STATUS" -eq 404 ]; then
          echo "‚ö†Ô∏è  Got $AZURE_STATUS - Checking if web.config is working..."
          echo "Try accessing: $AZURE_URL/index.html"
        else
          echo "‚ö†Ô∏è  Status $AZURE_STATUS - App might still be starting"
        fi
        
        echo ""
        echo "üåê Your URLs:"
        echo "   Azure: $AZURE_URL"
        echo "   Custom: https://app.tradieone.com"