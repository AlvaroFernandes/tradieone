name: Deploy to Azure

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - run: npm ci && npm run build
    
    - name: Add web.config
      run: |
        echo '<?xml version="1.0"?>
        <configuration><system.webServer>
        <rewrite><rules><rule name="SPA"><match url=".*"/>
        <conditions><add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true"/>
        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true"/></conditions>
        <action type="Rewrite" url="/index.html"/></rule></rules></rewrite>
        </system.webServer></configuration>' > dist/web.config
    
    - name: Deploy
      run: |
        cd dist
        zip -r app.zip .
        
        echo "Deploying with publish profile credentials..."
        
        # Deploy - this already worked!
        curl -X POST \
          -u '$TradieOne:n7jBcellkKxSWcPslaw4wKTRlPgQMsxmz6BQmaf6BPWdfbtEduqYJn2Ax6uu' \
          https://tradieone-gpefeegnfqf5dwau.scm.australiaeast-01.azurewebsites.net/api/zipdeploy \
          --data-binary @app.zip
        
        echo ""
        echo "‚úÖ Deployment successful!"
        echo "üåê Visit your app: https://app.tradieone.com"
        echo "üåê Azure URL: https://tradieone-gpefeegnfqf5dwau.australiaeast-01.azurewebsites.net"
    
    - name: Test deployment
      run: |
        echo "Testing deployed app..."
        sleep 3
        
        curl -s -o /dev/null -w "Azure URL: %{http_code}\n" \
          https://tradieone-gpefeegnfqf5dwau.australiaeast-01.azurewebsites.net \
          --max-time 10 || echo "Still starting..."
        
        curl -s -o /dev/null -w "Custom Domain: %{http_code}\n" \
          https://app.tradieone.com \
          --max-time 10 || echo "Still starting..."